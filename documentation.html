<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Documentation</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1, h2, h3 { color: #333; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        code { background-color: #f4f4f4; padding: 2px 4px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Project Documentation</h1>

    <h2>Overview</h2>
    <p>This is a Node.js Express API for a student management system. It supports admin and student roles, with features including account creation, login, attendance tracking, complaint management, announcements, department management, promotions, and more. The application uses PostgreSQL as the database via Supabase, JWT for authentication, and includes email verification and password reset functionality.</p>

    <h2>Architecture</h2>
    <p>The application follows a modular structure:</p>
    <ul>
        <li><strong>api/index.js</strong>: Main entry point, sets up Express app, middleware, and routes.</li>
        <li><strong>controllers/</strong>: Contains business logic for different modules (admin, student, account creation, etc.).</li>
        <li><strong>routers/</strong>: Defines API routes and maps them to controllers.</li>
        <li><strong>database/database.js</strong>: Database connection pool using pg library.</li>
        <li><strong>env.js</strong>: Loads environment variables from .env file.</li>
    </ul>

    <h2>Dependencies</h2>
    <table>
        <tr><th>Package</th><th>Version</th><th>Description</th></tr>
        <tr><td>@supabase/supabase-js</td><td>^2.57.2</td><td>Supabase client for database operations</td></tr>
        <tr><td>bcrypt</td><td>^6.0.0</td><td>Password hashing</td></tr>
        <tr><td>cookie-parser</td><td>^1.4.7</td><td>Parse cookies</td></tr>
        <tr><td>cors</td><td>^2.8.5</td><td>Cross-origin resource sharing</td></tr>
        <tr><td>dotenv</td><td>^17.2.2</td><td>Environment variables</td></tr>
        <tr><td>express</td><td>^5.1.0</td><td>Web framework</td></tr>
        <tr><td>fs</td><td>^0.0.1-security</td><td>File system</td></tr>
        <tr><td>googleapis</td><td>^160.0.0</td><td>Google APIs</td></tr>
        <tr><td>json2csv</td><td>^6.0.0-alpha.2</td><td>JSON to CSV conversion</td></tr>
        <tr><td>jsonwebtoken</td><td>^9.0.2</td><td>JWT tokens</td></tr>
        <tr><td>nodemailer</td><td>^7.0.6</td><td>Email sending</td></tr>
        <tr><td>pg</td><td>^8.16.3</td><td>PostgreSQL client</td></tr>
    </table>

    <h2>Database</h2>
    <p>The application uses PostgreSQL hosted on Supabase. Connection details are in <code>database/database.js</code>. Tables include admins, students, departments, attendance, complaints, announcements, refresh tokens, etc.</p>

    <h2>API Endpoints</h2>
    <p>Below is detailed documentation for each API endpoint, including request body and response format.</p>

    <h3>Authentication</h3>
    <h4>POST /adminslogin</h4>
    <p><strong>Description:</strong> Admin login</p>
    <p><strong>Request Body:</strong> <code>{ "email": "string", "password": "string" }</code></p>
    <p><strong>Response (Success):</strong> <code>{ "success": true, "message": "Admin login successful", "token": "jwt", "role": "admin", "data": {...} }</code></p>
    <p><strong>Response (Error):</strong> <code>{ "success": false, "error": "message" }</code></p>

    <h4>POST /studentslogin</h4>
    <p><strong>Description:</strong> Student login</p>
    <p><strong>Request Body:</strong> <code>{ "email": "string", "password": "string" }</code></p>
    <p><strong>Response (Success):</strong> <code>{ "success": true, "message": "Student login successful", "token": "jwt", "role": "student", "data": {...} }</code></p>
    <p><strong>Response (Error):</strong> <code>{ "success": false, "error": "message" }</code></p>

    <h3>Account Creation</h3>
    <h4>POST /register</h4>
    <p><strong>Description:</strong> Student registration</p>
    <p><strong>Request Body:</strong> <code>{ "email": "string" (required), "password": "string" (required), "name": "string" (required), "father_guardian_name": "string" (optional), "dob": "date" (optional), "blood_group": "string" (optional), "student_contact_number": "string" (optional), "parent_guardian_contact_number": "string" (optional), "address": "string" (optional), "department": "string" (optional), "academic_year": "string" (optional), "registration_number": "string" (required), "roll_number": "string" (optional), "room_number": "string" (optional), "profile_photo": "string" (optional) }</code></p>
    <p><strong>Response (Success):</strong> <code>{ "success": true, "message": "User registered successfully", "user": {...} }</code></p>
    <p><strong>Response (Error):</strong> <code>{ "success": false, "message": "error message" }</code></p>

    <h4>POST /emailpush</h4>
    <p><strong>Description:</strong> Send email for verification</p>
    <p><strong>Request Body:</strong> <code>{ "email": "string" }</code></p>
    <p><strong>Response:</strong> <code>{ "success": true/false, "message": "string" }</code></p>

    <h4>POST /emailverify</h4>
    <p><strong>Description:</strong> Verify email</p>
    <p><strong>Request Body:</strong> <code>{ "email": "string", "code": "string" }</code></p>
    <p><strong>Response:</strong> <code>{ "success": true/false, "message": "string" }</code></p>

    <h4>POST /sendcode</h4>
    <p><strong>Description:</strong> Send verification code</p>
    <p><strong>Request Body:</strong> <code>{ "email": "string" }</code></p>
    <p><strong>Response:</strong> <code>{ "success": true/false, "message": "string" }</code></p>

    <h4>GET /fetchdepartments</h4>
    <p><strong>Description:</strong> Fetch departments</p>
    <p><strong>Request:</strong> None</p>
    <p><strong>Response:</strong> <code>{ "success": true, "departments": [...] }</code></p>

    <h3>Student Management (Admin)</h3>
    <h4>GET /fetchstudents</h4>
    <p><strong>Description:</strong> Fetch students</p>
    <p><strong>Headers:</strong> Authorization: Bearer token</p>
    <p><strong>Response:</strong> <code>{ "success": true, "students": [...] }</code></p>

    <h4>POST /approve</h4>
    <p><strong>Description:</strong> Approve student</p>
    <p><strong>Headers:</strong> Authorization: Bearer token</p>
    <p><strong>Request Body:</strong> <code>{ "registerno": "string" }</code></p>
    <p><strong>Response:</strong> <code>{ "success": true, "message": "Student approved successfully", "student": {...} }</code></p>

    <h4>POST /adminreject</h4>
    <p><strong>Description:</strong> Reject student</p>
    <p><strong>Headers:</strong> Authorization: Bearer token</p>
    <p><strong>Request Body:</strong> <code>{ "registerno": "string" }</code></p>
    <p><strong>Response:</strong> <code>{ "success": true, "message": "string" }</code></p>

    <h4>POST /studentupdate</h4>
    <p><strong>Description:</strong> Update student</p>
    <p><strong>Headers:</strong> Authorization: Bearer token</p>
    <p><strong>Request Body:</strong> <code>{ "id": "number" (required), "name": "string" (optional), "father_guardian_name": "string" (optional), "dob": "date" (optional), "blood_group": "string" (optional), "student_contact_number": "string" (optional), "parent_guardian_contact_number": "string" (optional), "address": "string" (optional), "department": "string" (optional), "academic_year": "string" (optional), "registration_number": "string" (optional), "roll_number": "string" (optional), "room_number": "string" (optional), "profile_photo": "string" (optional) }</code></p>
    <p><strong>Response:</strong> <code>{ "success": true, "data": {...} }</code></p>

    <h4>POST /editstudentsdetails</h4>
    <p><strong>Description:</strong> Edit student details</p>
    <p><strong>Headers:</strong> Authorization: Bearer token</p>
    <p><strong>Request Body:</strong> <code>{ "id": "number" (required), "name": "string" (optional), "father_guardian_name": "string" (optional), "dob": "date" (optional), "blood_group": "string" (optional), "student_contact_number": "string" (optional), "parent_guardian_contact_number": "string" (optional), "address": "string" (optional), "department": "string" (optional), "academic_year": "string" (optional), "registration_number": "string" (optional), "roll_number": "string" (optional), "room_number": "string" (optional), "profile_photo": "string" (optional) }</code></p>
    <p><strong>Response:</strong> <code>{ "success": true, "message": "Student updated successfully" }</code></p>

    <h3>Attendance</h3>
    <p><strong>Note:</strong> For student endpoints, the user ID is automatically added by the studentauth middleware from the JWT token.</p>
    <h4>POST /attendance</h4>
    <p><strong>Description:</strong> Mark attendance</p>
    <p><strong>Headers:</strong> Authorization: Bearer token</p>
    <p><strong>Request Body:</strong> <code>{ "lat": "number", "lng": "number" }</code></p>
    <p><strong>Response (Success):</strong> <code>{ "success": true, "attendance": {...} }</code></p>
    <p><strong>Response (Error):</strong> <code>{ "success": false, "error": "message" }</code></p>

    <h4>POST /absent</h4>
    <p><strong>Description:</strong> Mark absent</p>
    <p><strong>Headers:</strong> Authorization: Bearer token</p>
    <p><strong>Request Body:</strong> <code>{ "lat": "number", "lng": "number" }</code></p>
    <p><strong>Response:</strong> <code>{ "success": true, "attendance": {...} }</code></p>
    <p><strong>Response (Error if inside hostel):</strong> <code>{ "success": false, "error": "Student inside hostel" }</code></p>

    <h4>POST /showattends</h4>
    <p><strong>Description:</strong> Show attendance with optional filters</p>
    <p><strong>Headers:</strong> Authorization: Bearer token</p>
    <p><strong>Request Body (optional):</strong> <code>{ "student_id": "number", "department": "string", "academic_year": "string", "from": "date", "to": "date" }</code></p>
    <p><strong>Response:</strong> <code>{ "success": true, "data": [...], "message": "string" }</code></p>

    <h4>POST /changeattendanceforadmin</h4>
    <p><strong>Description:</strong> Change attendance (admin)</p>
    <p><strong>Headers:</strong> Authorization: Bearer token</p>
    <p><strong>Request Body:</strong> <code>{ "student_id": "number", "date": "date", "status": "string" }</code></p>
    <p><strong>Response:</strong> <code>{ "success": true, "message": "string" }</code></p>

    <h4>POST /exportattendance</h4>
    <p><strong>Description:</strong> Export attendance records as CSV and send via email</p>
    <p><strong>Headers:</strong> Authorization: Bearer token</p>
    <p><strong>Request Body:</strong> <code>{ "from": "date" (required), "to": "date" (required), "email": "string" (required), "delete1": "boolean" (optional) }</code></p>
    <p><strong>Response (Success):</strong> <code>{ "success": true, "message": "Attendance CSV sent via email successfully" }</code></p>
    <p><strong>Response (Error):</strong> <code>{ "success": false, "error": "message" }</code></p>

    <h3>Complaints</h3>
    <h4>POST /registercomplaint</h4>
    <p><strong>Description:</strong> Register complaint</p>
    <p><strong>Headers:</strong> Authorization: Bearer token</p>
    <p><strong>Request Body:</strong> <code>{ "title": "string", "description": "string", "category": "string" (optional), "priority": "string" (optional) }</code></p>
    <p><strong>Response:</strong> <code>{ "success": true, "message": "Complaint registered successfully", "complaint": {...} }</code></p>

    <h4>GET /fetchcomplaintsforstudents</h4>
    <p><strong>Description:</strong> Fetch complaints for students</p>
    <p><strong>Headers:</strong> Authorization: Bearer token</p>
    <p><strong>Response:</strong> <code>{ "success": true, "complaints": [...] }</code></p>

    <h4>POST /editcomplaint</h4>
    <p><strong>Description:</strong> Edit complaint</p>
    <p><strong>Headers:</strong> Authorization: Bearer token</p>
    <p><strong>Request Body:</strong> <code>{ "complaint_id": "number" (required), "title": "string" (optional), "description": "string" (optional), "category": "string" (optional), "priority": "string" (optional) }</code></p>
    <p><strong>Response:</strong> <code>{ "success": true, "message": "Complaint updated successfully", "complaint": {...} }</code></p>

    <h4>GET /fetchcomplaintforadmins</h4>
    <p><strong>Description:</strong> Fetch complaints for admins</p>
    <p><strong>Headers:</strong> Authorization: Bearer token</p>
    <p><strong>Response:</strong> <code>{ "success": true, "complaints": [...] }</code></p>

    <h4>POST /complaintstatuschangeforadmin</h4>
    <p><strong>Description:</strong> Change complaint status</p>
    <p><strong>Headers:</strong> Authorization: Bearer token</p>
    <p><strong>Request Body:</strong> <code>{ "complaint_id": "number", "status": "string" }</code></p>
    <p><strong>Response:</strong> <code>{ "success": true, "message": "string" }</code></p>

    <h4>POST /resolvecomplaints</h4>
    <p><strong>Description:</strong> Resolve complaints</p>
    <p><strong>Headers:</strong> Authorization: Bearer token</p>
    <p><strong>Request Body:</strong> <code>{ "complaint_id": "number", "resolution": "string" }</code></p>
    <p><strong>Response:</strong> <code>{ "success": true, "message": "string" }</code></p>

    <h3>Password Reset</h3>
    <h4>POST /forgotpasswordemailpush</h4>
    <p><strong>Description:</strong> Forgot password email</p>
    <p><strong>Request Body:</strong> <code>{ "email": "string" }</code></p>
    <p><strong>Response:</strong> <code>{ "success": true, "message": "string" }</code></p>

    <h4>POST /forgotpasswordsendcode</h4>
    <p><strong>Description:</strong> Send forgot password code</p>
    <p><strong>Request Body:</strong> <code>{ "email": "string" }</code></p>
    <p><strong>Response:</strong> <code>{ "success": true, "message": "string" }</code></p>

    <h4>POST /veriycodeforgot</h4>
    <p><strong>Description:</strong> Verify forgot password code</p>
    <p><strong>Request Body:</strong> <code>{ "email": "string", "code": "string" }</code></p>
    <p><strong>Response:</strong> <code>{ "success": true, "message": "string" }</code></p>

    <h4>POST /changepassword</h4>
    <p><strong>Description:</strong> Change password</p>
    <p><strong>Request Body:</strong> <code>{ "email": "string", "new_password": "string" }</code></p>
    <p><strong>Response:</strong> <code>{ "success": true, "message": "string" }</code></p>

    <h3>Departments</h3>
    <h4>POST /adddepartments</h4>
    <p><strong>Description:</strong> Add department</p>
    <p><strong>Headers:</strong> Authorization: Bearer token</p>
    <p><strong>Request Body:</strong> <code>{ "name": "string", "description": "string" }</code></p>
    <p><strong>Response:</strong> <code>{ "success": true, "message": "string" }</code></p>

    <h4>POST /editdepartment</h4>
    <p><strong>Description:</strong> Edit department</p>
    <p><strong>Headers:</strong> Authorization: Bearer token</p>
    <p><strong>Request Body:</strong> <code>{ "id": "number", "name": "string", "description": "string" }</code></p>
    <p><strong>Response:</strong> <code>{ "success": true, "message": "string" }</code></p>

    <h4>POST /deletedepartment</h4>
    <p><strong>Description:</strong> Delete department</p>
    <p><strong>Headers:</strong> Authorization: Bearer token</p>
    <p><strong>Request Body:</strong> <code>{ "id": "number" }</code></p>
    <p><strong>Response:</strong> <code>{ "success": true, "message": "string" }</code></p>

    <h3>Promotion</h3>
    <h4>POST /promotion</h4>
    <p><strong>Description:</strong> Promote student</p>
    <p><strong>Headers:</strong> Authorization: Bearer token</p>
    <p><strong>Request Body:</strong> <code>{ "student_id": "number", "new_year": "string" }</code></p>
    <p><strong>Response:</strong> <code>{ "success": true, "message": "string" }</code></p>

    <h3>Announcements</h3>
    <h4>POST /pushannocement</h4>
    <p><strong>Description:</strong> Push announcement</p>
    <p><strong>Headers:</strong> Authorization: Bearer token</p>
    <p><strong>Request Body:</strong> <code>{ "title": "string", "content": "string" }</code></p>
    <p><strong>Response:</strong> <code>{ "success": true, "message": "string" }</code></p>

    <h4>GET /fetchannocementforadmin</h4>
    <p><strong>Description:</strong> Fetch announcements for admin</p>
    <p><strong>Headers:</strong> Authorization: Bearer token</p>
    <p><strong>Response:</strong> <code>{ "success": true, "announcements": [...] }</code></p>

    <h4>POST /editannouncementforadmin</h4>
    <p><strong>Description:</strong> Edit announcement</p>
    <p><strong>Headers:</strong> Authorization: Bearer token</p>
    <p><strong>Request Body:</strong> <code>{ "id": "number", "title": "string", "content": "string" }</code></p>
    <p><strong>Response:</strong> <code>{ "success": true, "message": "string" }</code></p>

    <h3>Notifications</h3>
    <h4>GET /fetchnotificationforstudents</h4>
    <p><strong>Description:</strong> Fetch notifications for students</p>
    <p><strong>Headers:</strong> Authorization: Bearer token</p>
    <p><strong>Response:</strong> <code>{ "success": true, "notifications": [...] }</code></p>

    <h4>POST /dismissnotificationforstudent</h4>
    <p><strong>Description:</strong> Dismiss notification</p>
    <p><strong>Headers:</strong> Authorization: Bearer token</p>
    <p><strong>Request Body:</strong> <code>{ "notification_id": "number" }</code></p>
    <p><strong>Response:</strong> <code>{ "success": true, "message": "string" }</code></p>

    <h2>Controllers</h2>
    <p>Controllers handle the business logic. Key controllers include:</p>
    <ul>
        <li><strong>adminLoginController.js</strong>: Handles admin login with password verification, JWT token generation, and refresh token storage.</li>
        <li><strong>studentLoginController.js</strong>: Similar to admin login but for students.</li>
        <li><strong>registration.js</strong>: Handles student registration.</li>
        <li><strong>attendance.js</strong>: Manages attendance marking.</li>
        <li><strong>complaint controllers</strong>: Handle complaint registration, fetching, editing, and resolution.</li>
        <li><strong>announcement controllers</strong>: Manage announcements.</li>
        <li><strong>department controllers</strong>: CRUD operations for departments.</li>
        <li><strong>promotion.js</strong>: Handles student promotions.</li>
        <li>And more...</li>
    </ul>

    <h2>Routers</h2>
    <p>Routers define the API paths and link to controllers. Each router corresponds to a specific functionality area.</p>

    <h2>Environment Variables</h2>
    <p>Environment variables are loaded from a .env file. Key variables include:</p>
    <ul>
        <li><code>SECRET_KEY</code>: For JWT signing</li>
        <li><code>TOKENLIFE</code>: Token expiration</li>
        <li><code>REFRESH_TOKEN_LIFE</code>: Refresh token expiration</li>
        <li><code>REFRESH_TOKEN_MAX_AGE_DAYS</code>: Cookie max age</li>
        <li>Database credentials (handled in database.js)</li>
        <li>Email service credentials for nodemailer</li>
    </ul>

    <h2>How to Run</h2>
    <ol>
        <li>Install dependencies: <code>npm install</code></li>
        <li>Set up .env file with required variables</li>
        <li>Run the server: <code>node api/index.js</code> or use a process manager</li>
        <li>The API will be available on port 3002</li>
    </ol>

    <h2>Testing</h2>
    <p>No automated tests are defined in package.json. Manual testing can be done using tools like Postman or curl to hit the endpoints.</p>
</body>
</html>
